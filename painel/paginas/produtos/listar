<?php
require_once("../../../conexao.php");

$query = $pdo->query("SELECT p.*, c.nome as categoria_nome
                      FROM produtos p 
                      LEFT JOIN categorias c ON p.categoria_id = c.id
                      ORDER BY p.id DESC");
$res = $query->fetchAll(PDO::FETCH_ASSOC);
$linhas = count($res);

if($linhas > 0){
    echo <<<HTML
    <small>
        <table class="table table-hover" id="tabela">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th class="esc">Preço</th>
                    <th class="esc">Categoria</th>
                    <th class="esc">Estoque</th>
                    <th class="esc">Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
    HTML;
    
    for($i = 0; $i < $linhas; $i++){
        $id = $res[$i]['id'] ?? '';
        $nome = $res[$i]['nome'] ?? '';
        $preco = $res[$i]['preco'] ?? '';
        $categoria_id = $res[$i]['categoria_id'] ?? '';
        $categoria_nome = $res[$i]['categoria_nome'] ?? '';
        $descricao = $res[$i]['descricao'] ?? '';
        $imagem = $res[$i]['imagem'] ?? '';
        $estoque = $res[$i]['estoque'] ?? '';
        $ativo = $res[$i]['ativo'] ?? '';
        $data_criacao = $res[$i]['data_criacao'] ?? '';

        $dataF = $data_criacao ? date('d/m/Y', strtotime($data_criacao)) : '';
        $precoF = 'R$ ' . number_format($preco, 2, ',', '.');

        // Botões para Ativar e Desativar
        if($ativo == 1 || $ativo == true){
            $icone = 'fa-check-square';
            $titulo_link = 'Desativar Produto';
            $acao = 0;
            $class_ativo = '';
            $status_texto = 'Ativo';
        } else {
            $icone = 'fa-check-o';
            $titulo_link = 'Ativar Produto';
            $acao = 1;
            $class_ativo = 'color: #c4c4c4;';
            $status_texto = 'Inativo';
        }

        // Escapar saída para segurança
        $nome_esc = htmlspecialchars($nome, ENT_QUOTES);
        $categoria_nome_esc = htmlspecialchars($categoria_nome, ENT_QUOTES);
        $tipo_nome_esc = htmlspecialchars($tipo_nome, ENT_QUOTES);
        $descricao_esc = htmlspecialchars($descricao, ENT_QUOTES);
        $imagem_esc = htmlspecialchars($imagem, ENT_QUOTES);
        $ativo_text = ($ativo == 1 || $ativo == true) ? 'Sim' : 'Não';

        // Preparar dados para JavaScript (escape especial)
        $nome_js = addslashes($nome_esc);
        $descricao_js = addslashes($descricao_esc);
        $imagem_js = addslashes($imagem_esc);
        $categoria_js = addslashes($categoria_nome_esc);
        $tipo_js = addslashes($tipo_nome_esc);

        echo <<<HTML
            <tr style="{$class_ativo}">
                <td>{$nome_esc}</td>
                <td class="esc">{$precoF}</td>
                <td class="esc">{$categoria_nome_esc}</td>
                <td class="esc">{$tipo_nome_esc}</td>
                <td class="esc">{$estoque}</td>
                <td class="esc">{$status_texto}</td>
                <td>
                    <a href="#" onclick="editarProduto('{$id}', '{$nome_js}', '{$preco}', '{$categoria_id}', '{$tipo_id}', '{$descricao_js}', '{$imagem_js}', '{$estoque}')" title="Editar Produto">
                        <i class="fa fa-edit text-primary"></i>
                    </a>
                    
                    <a href="#" onclick="mostrarProduto('{$nome_js}', '{$precoF}', '{$categoria_js}', '{$tipo_js}', '{$estoque}', '{$ativo_text}', '{$dataF}', '{$descricao_js}', '{$imagem_js}')" title="Visualizar Produto">
                        <i class="fa fa-info-circle text-info"></i>
                    </a>
                    
                    <a href="#" onclick="ativarProduto('{$id}', '{$acao}')" title="{$titulo_link}">
                        <i class="fa {$icone} text-success"></i>
                    </a>
                    
                    <a href="#" onclick="excluirProduto('{$id}')" title="Excluir Produto">
                        <i class="fa fa-trash text-danger"></i>
                    </a>
                </td>
            </tr>
        HTML;
    }

    echo <<<HTML
            </tbody>
        </table>
    </small>
    HTML;
    
} else {
    echo '<div class="alert alert-info"><small>Nenhum produto encontrado</small></div>';
}
?>

<script type="text/javascript">
    $(document).ready(function(){
        $('#tabela').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/2.3.1/i18n/pt-BR.json"
            },
            "ordering": true,
            "stateSave": true,
            "pageLength": 10,
            "order": [[ 0, "asc" ]]
        });
    });
</script>